version: '3'


services:
    hdfsnamenode:
        image: uhopper/hadoop-namenode:2.7.2
        hostname: hdfsnamenode
        volumes:
            - hdfsname:/hadoop/dfs/name
        ports:
            - "50070:50070"  # webui
            - "8020:8020"  # filesystem
        environment:
            - CLUSTER_NAME=ucsp
        deploy:
            placement:
                constraints:
                    - node.hostname == aldorithm

    hdfsdatanode1:
        image: uhopper/hadoop-datanode:2.7.2
        hostname: hdfsdatanode1
        depends_on:
            - hdfsnamenode
        volumes:
            - hdfsdatanode1:/hadoop/dfs/data
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
        deploy:
            placement:
                constraints:
                    - node.hostname == dj-PC

    hdfsdatanode2:
        image: uhopper/hadoop-datanode:2.7.2
        hostname: hdfsdatanode2
        depends_on:
            - hdfsnamenode
        volumes:
            - hdfsdatanode2:/hadoop/dfs/data
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
        deploy:
            placement:
                constraints:
                    - node.hostname == charles-Lenovo-G480

    hdfsdatanode3:
        image: uhopper/hadoop-datanode:2.7.2
        hostname: hdfsdatanode3
        depends_on:
            - hdfsnamenode
        volumes:
            - hdfsdatanode3:/hadoop/dfs/data
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
        deploy:
            placement:
                constraints:
                    - node.hostname == dj-PC

    yarnresourcemanager:
        image: uhopper/hadoop-resourcemanager:2.7.2
        hostname: yarnresourcemanager
        depends_on:
            - hdfsnamenode
        ports:
            - "8088:8088"  # webui
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
        deploy:
            placement:
                constraints:
                    - node.hostname == aldorithm

    yarnnodemanager1:
        image: uhopper/hadoop-nodemanager:2.7.2
        hostname: yarnnodemanager1
        depends_on:
            - hdfsnamenode
            - yarnresourcemanager
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
            - YARN_CONF_yarn_resourcemanager_hostname=yarnresourcemanager
        deploy:
            placement:
                constraints:
                    - node.hostname == dj-PC

    yarnnodemanager2:
        image: uhopper/hadoop-nodemanager:2.7.2
        hostname: yarnnodemanager2
        depends_on:
            - hdfsnamenode
            - yarnresourcemanager
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
            - YARN_CONF_yarn_resourcemanager_hostname=yarnresourcemanager
        deploy:
            placement:
                constraints:
                    - node.hostname == charles-Lenovo-G480

    yarnnodemanager3:
        image: uhopper/hadoop-nodemanager:2.7.2
        hostname: yarnnodemanager3
        depends_on:
            - hdfsnamenode
            - yarnresourcemanager
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
            - YARN_CONF_yarn_resourcemanager_hostname=yarnresourcemanager
        deploy:
            placement:
                constraints:
                    - node.hostname == dj-PC

    runner:
        image: alculquicondor/hadoop-runner
        build:
            dockerfile: dockerfiles/runner.Dockerfile
            context: .
        volumes:
            - ./data:/root/data
        depends_on:
            - hdfsnamenode
            - yarnresourcemanager
        environment:
            - CORE_CONF_fs_defaultFS=hdfs://hdfsnamenode:8020
            - YARN_CONF_yarn_resourcemanager_hostname=yarnresourcemanager
        command: tail -f /var/log/dmesg
        deploy:
            placement:
                constraints:
                    - node.hostname == aldorithm


volumes:
    hdfsname:
    hdfsdatanode1:
    hdfsdatanode2:
    hdfsdatanode3:
